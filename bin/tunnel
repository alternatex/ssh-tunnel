#!/usr/bin/env node

"use strict";

var version = '2.1.0';

// module dependencies
var _ = require("underscore");
var colors = require("colors");
var inquirer = require("inquirer");
var fs = require("fs");
var tunnel = require("../").tunnel('');

// say hi
console.log('Tunnel'.white.bold); 
console.log(('Version: '+version).white); 
console.log();

// bootstrap
var config = {};
var configFilename = 'tunnel.conf';

try {
  config = JSON.parse(fs.readFileSync(configFilename, 'utf8'));
} catch(ex){
  console.log(ex);
  fs.writeFileSync(configFilename, JSON.stringify({
    "Development": defaultConnection(),  
    "Staging": defaultConnection(),  
    "Production": defaultConnection()
  }, null, 2), 'utf8');
}

var actions = {
  'new': 'New connection'
};

var connactions = {
  'copy': 'Copy',
  'remove': 'Remove',
  'update': 'Update'
};

var choices = [];
choices.push(actions['new']);
choices.push(new inquirer.Separator());
choices = choices.concat(_.keys(config));

// ...
inquirer.prompt([
  {
    type      : "list",
    name      : "connection",
    message   : "Select Connection".yellow,
    paginated : true,
    choices   : choices
  }], function( answers ) {

  if(answers.connection==actions['new']){
    promptConnection();
  } else {
    promptConnection(answers.connection);
  }
  //console.log( JSON.stringify(answers, null, "  ") );
  //tunnel.emit('selected');
}); 

tunnel.on('connect', function(){
  console.log("Establishing connection".green);
});

// defaults
function defaultConnection(){
  return { 
    "local": {
      "hostname": "localhost",
      "port": 80
    },
    "remote": {
      "network": "host.tld",
      "hostname": "localhost",
      "port": 80,
      "username": "user"
    }
  };
}

// new
function newConnection(id){

};

// list
function showConnections(){

};

// show
function showConnection(id){

};

// delete
function deleteConnection(id){

};

// store?
function promptStore(id){
  inquirer.prompt([{
      type: "confirm",
      message: "Do you want to bookmark this connection?",
      name: "bookmark",
      default: true
    }], function(answers){
      if(answers.bookmark){
        fs.writeFileSync(configFilename, JSON.stringify(config, null, 2), 'utf8');    
      }
      console.log(answers);
      promptConnect(id);
    });  
}

// connect?
function promptConnect(id){
  inquirer.prompt([
    {
      type: "confirm",
      message: "Do you want to connect?",
      name: "connect",
      default: true
    }], function(answers){
      console.log(answers);
      if(answers.connect) {
        tunnel.connect('localhost', 8080, 'somehost.com', '127.0.0.1', 4502, 'someuser');
      }      
    });  
}

// edit/new
function promptConnection(id){
  
  var connection = (typeof(id)=='undefined' || typeof(config[id])!='object') ? defaultConnection() : config[id];

  inquirer.prompt([
    {
      type: "input",
      message: "Enter connection name",
      name: "name",
      default: id
    },
    {
      type: "input",
      message: "Enter local hostname",
      name: "local.hostname",
      default: connection.local.hostname
    },
    {
      type: "input",
      message: "Enter local port",
      name: "local.port",
      default: connection.local.port
    },
    {
      type: "input",
      message: "Enter remote network",
      name: "remote.network",
      default: connection.remote.network
    },
    {
      type: "input",
      message: "Enter remote hostname",
      name: "remote.hostname",
      default: connection.remote.hostname
    },
    {
      type: "input",
      message: "Enter remote port",
      name: "remote.port",
      default: connection.remote.port
    },
    {
      type: "input",
      message: "Enter remote username",
      name: "remote.username",
      default: connection.remote.username
    }

  ], function( answers ) {
    console.log(answers);    
    
    var name = answers['name'];
    delete answers['name'];

    var data = {};
    _(answers).each(function(answer, index){
      var segments = index.split('.');
      if(typeof(data[segments[0]])=='undefined'){
        data[segments[0]] = {};
      }
      data[segments[0]][segments[1]] = answer;
    });

    console.log("data", data);

    // attach
    config[name]=data;

    // if connection got renamed, delete the old entry
    if(name!=id) delete config[id];      

    // prompt user
    promptStore(name);

    // emit event?
    tunnel.emit('event');
  });
}